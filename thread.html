<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link rel="icon" href="/favicon.ico">
    <!-- Метатеги для iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="TG Imgboard">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2678b6">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-touch-fullscreen" content="yes">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json">
    <title>TG Imgboard - Тред</title>

    <!-- Загружаем Telegram WebApp скрипт до основного приложения -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Загружаем Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Встроенные базовые стили -->
    <style>
      :root {
        --tg-theme-bg-color: #ffffff;
        --tg-theme-text-color: #222222;
        --tg-theme-hint-color: #999999;
        --tg-theme-link-color: #2678b6;
        --tg-theme-button-color: #2678b6;
        --tg-theme-button-text-color: #ffffff;
        --tg-theme-secondary-bg-color: #f5f5f5;
        --safe-area-inset-top: env(safe-area-inset-top, 0px);
        --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      }
      
      html.dark {
        --tg-theme-bg-color: #212121;
        --tg-theme-text-color: #ffffff;
        --tg-theme-hint-color: #aaaaaa;
        --tg-theme-link-color: #8cc2ff;
        --tg-theme-button-color: #2678b6;
        --tg-theme-button-text-color: #ffffff;
        --tg-theme-secondary-bg-color: #292929;
      }
      
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      
      html, body {
        height: 100%;
        width: 100%;
        padding: 0;
        margin: 0;
        overflow: hidden;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: var(--tg-theme-bg-color);
        color: var(--tg-theme-text-color);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        -webkit-text-size-adjust: 100%;
        -webkit-font-smoothing: antialiased;
      }
      
      #app {
        height: 100%;
        width: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        position: relative;
        touch-action: pan-y;
      }
      
      #app-loading {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: var(--tg-theme-bg-color);
        color: var(--tg-theme-text-color);
        transition: opacity 0.3s;
        z-index: 9999;
      }
      
      #app-loading.hidden {
        opacity: 0;
        pointer-events: none;
        z-index: -1;
      }
      
      .spinner {
        width: 40px;
        height: 40px;
        margin-bottom: 20px;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--tg-theme-button-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      html.dark .spinner {
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-left-color: var(--tg-theme-link-color);
      }
      
      .loading-text {
        font-size: 14px;
        letter-spacing: 1px;
        font-weight: bold;
      }
      
             @keyframes spin {
         to { transform: rotate(360deg); }
       }
       
               @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.02); }
          100% { transform: scale(1); }
        }
        
        /* Анимация свайпа вправо */
        @keyframes swipeRight {
          0% { transform: translateX(0); }
          100% { transform: translateX(100%); }
        }
        
        .swipe-indicator {
          position: fixed;
          top: 50%;
          left: 20px;
          transform: translateY(-50%);
          background-color: var(--tg-theme-button-color);
          color: var(--tg-theme-button-text-color);
          padding: 12px 16px;
          border-radius: 20px;
          font-size: 14px;
          font-weight: 500;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
          z-index: 1001;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .swipe-indicator.show {
          opacity: 1;
        }
        
        .swipe-indicator.swiping {
          animation: swipeRight 0.3s ease-out forwards;
        }

      /* Стили для постов */
      .thread-container {
        padding: 16px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .thread-header {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        width: 120%;
        z-index: 1000;
        align-items: center;
        gap: 18px;
        margin-bottom: 24px;
        padding: 16px;
        background-color: rgb(255, 255, 255);
        border-bottom: 1px solid rgba(0,0,0,0.1);
      }

      html.dark .thread-header {
        border-color: rgba(255,255,255,0.1);
        background-color: rgb(22, 22, 22);
      }

      .back-button {
        background-color: rgba(121, 115, 115, 0.1);
        border: 1px solid rgba(71, 49, 49, 0.1);
        font-size: 14px;
        font-weight: bold;
        color: var(--tg-theme-text-color);
        cursor: pointer;
        padding: 8px;
        border-radius: 18px;
        margin-left: 26%;
        margin-top: 8.5%;
        transition: background-color 0.2s ease;
      }

      .back-button:hover {
        background-color: rgba(0,0,0,0.1);
      }

      html.dark .back-button:hover {
        background-color: rgba(255,255,255,0.1);
      }

      .thread-info {
        flex: 1;
      }

      .thread-id {
        font-family: monospace;
        font-weight: bold;
        color: var(--tg-theme-button-color);
        font-size: 18px;
        margin-bottom: 4px;
      }

      .thread-title {
        font-weight: 600;
        font-size: 20px;
        margin-bottom: 8px;
      }

      .thread-description {
        font-size: 14px;
        color: var(--tg-theme-hint-color);
        line-height: 1.4;
      }

      .posts-container {
        display: flex;
        flex-direction: column;
        margin-top: 50%;
        gap: 12px;
        padding: 16px;
      }

      .post-card {
        background-color: var(--tg-theme-bg-color);
        border-radius: 8px;
        padding: 16px;
        transition: all 0.2s ease;
        position: relative;
        border: 1px solid rgba(0,0,0,0.1);
      }

      html.dark .post-card {
        background-color: var(--tg-theme-secondary-bg-color);
        border-color: rgba(255,255,255,0.1);
      }

      .post-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(92, 89, 89, 0.1);
        background-color: var(--tg-theme-secondary-bg-color);
      }

      html.dark .post-card:hover {
        background-color: rgba(221, 221, 221, 0.1);
      }

      /* Разделители между постами */
      .post-card:not(:last-child)::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 16px;
        right: 16px;
        height: 1px;
        background-color: rgba(0, 0, 0, 0.1);
      }

      html.dark .post-card:not(:last-child)::after {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .post-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
        font-size: 14px;
        color: var(--tg-theme-hint-color);
      }

      .post-number {
        font-weight: bold;
        color: var(--tg-theme-button-color);
      }

      .post-date {
        color: var(--tg-theme-hint-color);
      }

      .post-content {
        margin-bottom: 12px;
        line-height: 1.6;
        display: flex;
        gap: 16px;
        align-items: flex-start;
      }

      .post-thumb {
        flex-shrink: 0;
        width: 80px;
        height: 80px;
        border-radius: 6px;
        margin-top: 5px;
        overflow: hidden;
        background-color: var(--tg-theme-secondary-bg-color);
      }

      .post-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.2s ease;
        cursor: zoom-in;
      }

      .post-thumb img:hover {
        transform: scale(1.02);
      }

      .post-info {
        flex: 1;
        min-width: 0;
      }

             .post-text {
         margin-bottom: 12px;
         white-space: pre-wrap;
         word-wrap: break-word;
         line-height: 1.6;
       }
       
       /* Стили для обработанных HTML элементов */
       .post-text strong {
         font-weight: bold;
       }
       
       .post-text em {
         font-style: italic;
       }
       
       .post-text u {
         text-decoration: underline;
       }
       
       .post-text del {
         text-decoration: line-through;
         color: var(--tg-theme-hint-color);
       }
       
       .post-text code {
         background-color: var(--tg-theme-secondary-bg-color);
         padding: 2px 4px;
         border-radius: 3px;
         font-family: monospace;
         font-size: 0.9em;
       }
       
       .post-text .spoiler {
         background-color: var(--tg-theme-text-color);
         color: var(--tg-theme-text-color);
         padding: 2px 4px;
         border-radius: 3px;
         cursor: pointer;
         user-select: none;
         transition: all 0.2s ease;
       }
       
       .post-text .spoiler.revealed {
         background-color: transparent;
         color: inherit;
       }
       
       .post-text .spoiler:hover {
         background-color: var(--tg-theme-hint-color);
       }
       
       .post-text .post-quote {
         border-left: 3px solid var(--tg-theme-hint-color);
         padding-left: 12px;
         margin: 8px 0;
         color: var(--tg-theme-hint-color);
         font-style: italic;
       }
       
               .post-text .post-link {
          color: var(--tg-theme-link-color);
          text-decoration: none;
          font-weight: bold;
          background-color: rgba(38, 120, 182, 0.1);
          padding: 2px 6px;
          border-radius: 4px;
          transition: all 0.2s ease;
          cursor: pointer;
          display: inline-block;
          user-select: none;
          position: relative;
          z-index: 1;
        }
       
       .post-text .post-link:hover {
         background-color: rgba(38, 120, 182, 0.2);
         transform: translateY(-1px);
         box-shadow: 0 2px 4px rgba(38, 120, 182, 0.2);
       }
       
       .post-text .post-link:active {
         transform: translateY(0);
         box-shadow: 0 1px 2px rgba(38, 120, 182, 0.2);
       }
       
       .post-text .external-link {
         color: var(--tg-theme-link-color);
         text-decoration: none;
       }
       
               .post-text .external-link:hover {
          text-decoration: underline;
        }
        
        /* Стили для ссылок на ответы (если есть) */
        .post-text .post-reply-link {
          color: var(--tg-theme-link-color);
          text-decoration: none;
          font-weight: bold;
          background-color: rgba(38, 120, 182, 0.05);
          padding: 1px 4px;
          border-radius: 3px;
          transition: all 0.2s ease;
          cursor: pointer;
          display: inline-block;
          user-select: none;
          position: relative;
          z-index: 0;
        }
        
        .post-text .post-reply-link:hover {
          background-color: rgba(38, 120, 182, 0.1);
        }

      .post-files {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }
      
      /* Галерея изображений 2x2 */
      .post-gallery {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-top: 12px;
      }
      .post-gallery .gallery-item {
        position: relative;
        width: 100%;
        padding-top: 100%; /* квадрат */
        overflow: hidden;
        border-radius: 6px;
        background-color: var(--tg-theme-secondary-bg-color);
      }
      .post-gallery .gallery-item img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: zoom-in;
      }
      
      .post-videos {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
      }

      .post-file {
        max-width: 200px;
        border-radius: 6px;
        overflow: hidden;
        background-color: var(--tg-theme-secondary-bg-color);
      }

      .post-file img {
        width: 100%;
        height: auto;
        display: block;
        cursor: zoom-in;
      }

      .post-file video {
        width: 100%;
        height: auto;
        display: block;
      }

      .error-message {
        text-align: center;
        padding: 32px;
        color: var(--tg-theme-hint-color);
      }

      .retry-button {
        background-color: var(--tg-theme-button-color);
        color: var(--tg-theme-button-text-color);
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 16px;
        transition: opacity 0.2s ease;
      }

      .retry-button:hover {
        opacity: 0.8;
      }

      .loading-more {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 20px;
        color: var(--tg-theme-hint-color);
        font-size: 14px;
      }

      .spinner.small {
        width: 20px;
        height: 20px;
        border-width: 2px;
      }

      .load-more-button {
        display: flex;
        justify-content: center;
        padding: 20px;
      }

      .load-more-btn {
        background-color: var(--tg-theme-button-color);
        color: var(--tg-theme-button-text-color);
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: opacity 0.2s ease;
      }

             .load-more-btn:hover {
         opacity: 0.8;
       }
       
       /* Уведомления */
       .post-notification {
         position: fixed;
         top: 20px;
         left: 50%;
         transform: translateX(-50%) translateY(-100px);
         background-color: var(--tg-theme-button-color);
         color: var(--tg-theme-button-text-color);
         padding: 12px 20px;
         border-radius: 8px;
         font-size: 14px;
         font-weight: 500;
         z-index: 10000;
         box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
         transition: transform 0.3s ease;
         pointer-events: none;
       }
       
       .post-notification.show {
         transform: translateX(-50%) translateY(0);
       }
       
       html.dark .post-notification {
         box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
       }

        /* Красная плашка-алерт */
        .alert-banner {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          transform: translateY(-100%);
          background-color: #d32f2f;
          color: #ffffff;
          padding: 12px 16px;
          text-align: center;
          font-size: 14px;
          font-weight: 600;
          z-index: 11000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.25);
          transition: transform 0.25s ease;
        }
        .alert-banner.show {
          transform: translateY(0);
        }
        html.dark .alert-banner {
          background-color: #ef5350;
          box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        /* Lightbox */
        .lightbox-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 2000;
          padding: 16px;
        }
        .lightbox-content {
          max-width: 80vw;
          max-height: 85vh;
          display: flex;
          flex-direction: column;
          gap: 12px;
          align-items: center;
        }
        .lightbox-image {
          max-width: 80vw;
          max-height: 80vh;
          object-fit: contain;
          border-radius: 8px;
          box-shadow: 0 6px 24px rgba(0, 0, 0, 0.4);
          background: #000;
          cursor: zoom-out;
        }
        .lightbox-info {
          color: #ffffff;
          font-size: 13px;
          opacity: 0.9;
          text-align: center;
        }
        .lightbox-close {
          position: absolute;
          top: 12px;
          right: 12px;
          color: #ffffff;
          background: rgba(0, 0, 0, 0.45);
          border: none;
          border-radius: 16px;
          padding: 8px 12px;
          cursor: pointer;
        }

      /* Адаптивность для мобильных устройств */
      @media (max-width: 768px) {
        .thread-container {
          padding: 12px;
        }
        
        .thread-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
          padding: 12px;
        }
        
        .posts-container {
          padding: 12px;
        }
        
        .post-card {
          padding: 12px;
        }
        
        .post-card:not(:last-child)::after {
          left: 12px;
          right: 12px;
        }
        
        .post-files {
          flex-direction: column;
        }
        
        .post-file {
          max-width: 100%;
        }
        
        .post-thumb {
          width: 60px;
          height: 60px;
        }
        
        .post-gallery {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <!-- Базовый экран загрузки -->
    <div id="app-loading">
      <div class="spinner"></div>
      <div class="loading-text">Загрузка...</div>
    </div>
    
    <!-- Контейнер для Vue приложения -->
    <div id="app" style="display: none;"></div>

    <script>
      // Определяем iOS устройства
      var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      // Базовая проверка наличия Telegram WebApp API
      window.addEventListener('DOMContentLoaded', function() {
        // Элементы страницы
        var appLoading = document.getElementById('app-loading');
        var vueApp = document.getElementById('app');
        var isAppHidden = false;
        
        // Получаем параметры из URL
        const urlParams = new URLSearchParams(window.location.search);
        const boardId = urlParams.get('board');
        const threadId = urlParams.get('thread');
        
        if (!boardId || !threadId) {
          // Если нет параметров, возвращаемся на главную
          window.location.href = 'index.html';
          return;
        }
        
        // Настраиваем для iOS
        if (isIOS) {
          document.body.classList.add('ios');
          
          // Предотвращаем скроллинг страницы целиком на iOS
          document.addEventListener('touchmove', function(event) {
            if (event.target.closest('#app') || event.target.closest('.thread-container')) {
              return;
            }
            event.preventDefault();
          }, { passive: false });
        }
        
        // Инициализация Telegram API
        var tg = null;
        if (window.Telegram && window.Telegram.WebApp) {
          tg = window.Telegram.WebApp;
          
          // Отключаем свайп вниз для закрытия приложения
          try {
            if (window.Telegram && window.Telegram.WebApp) {
              var eventData = JSON.stringify({ allow_vertical_swipe: false });
              if (window.TelegramWebviewProxy) {
                window.TelegramWebviewProxy.postEvent('web_app_setup_swipe_behavior', eventData);
              } else {
                window.parent.postMessage(JSON.stringify({
                  eventType: 'web_app_setup_swipe_behavior',
                  eventData: { allow_vertical_swipe: false }
                }), 'https://web.telegram.org');
              }
              console.log('Свайп вниз отключен');
            }
          } catch (e) {
            console.error('Ошибка при отключении свайпа вниз:', e);
          }
          
          // Скрываем кнопку "Назад" в левом верхнем углу
          try {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.BackButton) {
              window.Telegram.WebApp.BackButton.hide();
              console.log('Кнопка "Назад" скрыта');
            }
          } catch (e) {
            console.error('Ошибка при скрытии кнопки "Назад":', e);
          }
          
          // Применяем темную тему если нужно
          if (tg.colorScheme === 'dark') {
            document.documentElement.classList.add('dark');
          }
          
          // Настройка переменных CSS на основе Telegram темы
          if (tg.themeParams) {
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color);
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color);
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color);
            document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color);
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color);
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color);
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color);
          }
        }
        
        
         
         // Функция скрытия экрана загрузки
         window.hideLoading = function() {
          if (isAppHidden) return;
          isAppHidden = true;
          
          appLoading.classList.add('hidden');
          
          try {
            // Инициализация Vue после DOMContentLoaded
            const { createApp } = Vue;

            createApp({
              data() {
                                 return {
                   boardId: boardId,
                   threadId: threadId,
                   threadInfo: null,
                   posts: [],
                   allPosts: [],
                   loading: false,
                   error: null,
                   page: 1,
                   postsPerPage: 20,
                   hasMore: true,
                   loadingMore: false,
                   showSwipeIndicator: false,
                   touchStartX: 0,
                   touchStartY: 0,
                   touchEndX: 0,
                   touchEndY: 0
                 };
              },
              methods: {
                async loadThreadInfo() {
                  try {
                    // Здесь можно загрузить информацию о треде
                    // Пока используем заглушку
                    this.threadInfo = {
                      id: this.threadId,
                      boardId: this.boardId,
                      title: '',
                      description: ''
                    };
                  } catch (e) {
                    console.error('Ошибка при загрузке информации о треде:', e);
                  }
                },
                
                async loadPosts() {
                  this.loading = true;
                  this.error = null;
                  this.page = 1;
                  
                  try {
                    // Загружаем все посты
                    const allPosts = await this.fetchPosts();
                    this.allPosts = allPosts;
                     // Обновляем заголовок треда на основе первого поста
                     this.updateThreadTitle();
                    
                    // Показываем первую страницу
                    this.loadNextPage();
                  } catch (e) {
                    console.error('Ошибка при загрузке постов:', e);
                    this.error = 'Не удалось загрузить посты. Возможно, проблема с CORS.';
                  } finally {
                    this.loading = false;
                  }
                },
                
                                 loadNextPage() {
                   if (!this.hasMore || this.loadingMore) return;
                   
                   this.loadingMore = true;
                   
                   // Имитируем задержку для плавности
                   setTimeout(() => {
                     const startIndex = (this.page - 1) * this.postsPerPage;
                     const endIndex = startIndex + this.postsPerPage;
                     const newPosts = this.allPosts.slice(startIndex, endIndex);
                     
                     this.posts.push(...newPosts);
                     this.page++;
                     
                     // Проверяем, есть ли еще посты
                     this.hasMore = endIndex < this.allPosts.length;
                     this.loadingMore = false;
                     
                     // Настраиваем ссылки для новых постов
                     this.$nextTick(() => {
                       this.setupPostLinks();
                     });
                   }, 300);
                 },
                
                onScroll() {
                  // Проверяем, достигли ли конца списка
                  const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                  const scrollHeight = document.documentElement.scrollHeight || document.body.scrollHeight;
                  const clientHeight = document.documentElement.clientHeight || window.innerHeight;
                  
                  if (scrollTop + clientHeight >= scrollHeight - 100) {
                    this.loadNextPage();
                  }
                },
                
                async fetchPosts() {
                  // Используем codetabs прокси для обхода CORS
                  const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=https://2ch.hk/${this.boardId}/res/${this.threadId}.json`;
                  
                  try {
                    console.log('Загружаем посты через codetabs прокси...');
                    const response = await fetch(proxyUrl, {
                      method: 'GET',
                      headers: {
                        'Accept': 'application/json'
                      }
                    });
                    
                    if (response.ok) {
                      const data = await response.json();
                      console.log('Посты получены через codetabs:', data);
                      return this.parsePosts(data);
                    } else {
                      throw new Error(`HTTP ${response.status}`);
                    }
                  } catch (e) {
                    console.error('Ошибка загрузки постов через codetabs:', e);
                    throw new Error('Не удалось загрузить посты через codetabs прокси');
                  }
                },
                
                parsePosts(data) {
                  if (data.threads && data.threads[0] && data.threads[0].posts) {
                    return data.threads[0].posts.map(post => ({
                      id: post.num,
                      date: post.date * 1000,
                      text: post.comment || '',
                      files: (post.files || []).map(f => {
                        const guessedThumb = (typeof f.path === 'string' && f.path.includes('/src/'))
                          ? f.path.replace('/src/', '/thumb/')
                          : null;
                        return {
                          path: f.path,
                          thumbnail: f.thumbnail || f.thumbnail_path || f.thumbnail_url || f.preview || guessedThumb,
                          name: f.name || '',
                          size: typeof f.size === 'number' ? f.size : (f.size_bytes || f.filesize || null),
                          type: f.type
                        };
                      }),
                      subject: post.subject || ''
                    }));
                  }
                  
                  return [];
                },
                
                formatTimestamp(timestamp) {
                  if (!timestamp || timestamp === 0) return 'Неизвестно';
                  
                  let date;
                  
                  // Пробуем разные форматы timestamp
                  if (typeof timestamp === 'string') {
                    date = new Date(timestamp);
                  } else if (timestamp < 10000000000) {
                    date = new Date(timestamp * 1000);
                  } else {
                    date = new Date(timestamp);
                  }
                  
                  if (isNaN(date.getTime()) || date.getFullYear() < 2000) {
                    date = new Date();
                  }
                  
                  // Форматируем дату в формате дд.мм.гг
                  const day = date.getDate().toString().padStart(2, '0');
                  const month = (date.getMonth() + 1).toString().padStart(2, '0');
                  const year = date.getFullYear().toString().slice(-2);
                  
                  return `${day}.${month}.${year}`;
                },
                
                goBack() {
                  window.location.href = `board.html?id=${this.boardId}`;
                },
                
                                 retryLoad() {
                   this.loadPosts();
                 },
                 
                 processPostText(text) {
                   if (!text) return '';
                   
                   // Обрабатываем HTML теги
                   let processedText = text
                     // Заменяем <br> на переносы строк
                     .replace(/<br\s*\/?>/gi, '<br>')
                     // Обрабатываем ссылки на посты (>>123456) - создаем span с data-атрибутом
                     .replace(/>>(\d+)(?![^<]*>)/g, '<span class="post-link" data-post="$1">>>$1</span>')
                     // Обрабатываем ссылки на посты в формате >>123456 (с пробелами)
                     .replace(/(?<!<[^>]*)(>>\s*(\d+))/g, '<span class="post-link" data-post="$2">>>$2</span>')
                     // Обрабатываем ссылки на треды
                     .replace(/<a\s+href="([^"]+)"[^>]*>([^<]+)<\/a>/gi, '<a href="$1" target="_blank" class="external-link">$2</a>')
                     // Обрабатываем жирный текст
                     .replace(/<b>([^<]+)<\/b>/gi, '<strong>$1</strong>')
                     // Обрабатываем курсив
                     .replace(/<i>([^<]+)<\/i>/gi, '<em>$1</em>')
                     // Обрабатываем подчеркнутый текст
                     .replace(/<u>([^<]+)<\/u>/gi, '<u>$1</u>')
                     // Обрабатываем зачеркнутый текст
                     .replace(/<s>([^<]+)<\/s>/gi, '<del>$1</del>')
                     // Обрабатываем код
                     .replace(/<code>([^<]+)<\/code>/gi, '<code class="post-code">$1</code>')
                     // Обрабатываем спойлеры
                     .replace(/<spoiler>([^<]+)<\/spoiler>/gi, '<span class="spoiler" onclick="this.classList.toggle(\'revealed\')">$1</span>')
                     // Обрабатываем цитаты
                     .replace(/<quote>([^<]+)<\/quote>/gi, '<blockquote class="post-quote">$1</blockquote>');
                   
                   return processedText;
                 },
                 
                 setupPostLinks() {
                   // Проверяем, не добавлен ли уже обработчик
                   if (this.postLinksHandler) {
                     document.removeEventListener('click', this.postLinksHandler);
                   }
                   
                   // Создаем новый обработчик
                  this.postLinksHandler = (e) => {
                    const el = e.target;
                    if (el && el.classList && el.classList.contains('post-link')) {
                       e.preventDefault();
                       e.stopPropagation();
                       
                      const postNum = el.getAttribute('data-post');
                       if (postNum) {
                         this.scrollToPost(postNum);
                       }
                     }
                   };
                   
                   // Добавляем обработчик
                   document.addEventListener('click', this.postLinksHandler);
                 },
                 

                 
                  scrollToPost(postNum) {
                    const normalized = Number(postNum);
                    if (!normalized || normalized < 1) {
                      this.showAlert('Некорректная ссылка на пост');
                      return;
                    }
                    // Ищем пост в DOM
                    const postElement = document.querySelector(`[data-post-id="${normalized}"]`);
                    if (postElement) {
                      postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                      postElement.style.backgroundColor = 'rgba(38, 120, 182, 0.15)';
                      postElement.style.border = '2px solid var(--tg-theme-button-color)';
                      setTimeout(() => {
                        postElement.style.backgroundColor = '';
                        postElement.style.border = '';
                      }, 1200);
                      postElement.style.animation = 'pulse 0.6s ease-in-out';
                      setTimeout(() => { postElement.style.animation = ''; }, 600);
                      return;
                    }
                    // Проверяем, есть ли такой пост в данных
                    const existsInData = Array.isArray(this.allPosts) && this.allPosts.some(p => p.id == normalized);
                    if (!existsInData) {
                      this.showAlert(`Пост #${normalized} не найден`);
                      return;
                    }
                    // Пост есть, но не отрисован — догружаем
                    this.loadPostAndScroll(normalized);
                  },

                  updateThreadTitle() {
                    try {
                      if (!this.threadInfo) {
                        this.threadInfo = { id: this.threadId, boardId: this.boardId, title: '', description: '' };
                      }
                      if (Array.isArray(this.allPosts) && this.allPosts.length > 0) {
                        const opWithSubject = this.allPosts.find(p => p.subject && String(p.subject).trim().length > 0);
                        const op = opWithSubject || this.allPosts[0];
                        let title = '';
                        if (op.subject && String(op.subject).trim().length > 0) {
                          title = String(op.subject).trim();
                        } else if (op.text) {
                          // Берем немного текста из первого поста как заголовок, убирая HTML
                          const plain = String(op.text)
                            .replace(/<br\s*\/?>(\r?\n)?/gi, ' ')
                            .replace(/<[^>]*>/g, ' ')
                            .replace(/\s+/g, ' ')
                            .trim();
                          title = plain.slice(0, 80) || '';
                        }
                        if (title) {
                          this.threadInfo.title = title;
                        } else {
                          this.threadInfo.title = 'Без названия';
                        }
                      }
                    } catch (e) {
                      console.warn('Не удалось обновить заголовок треда:', e);
                    }
                  },
                 
                  async loadPostAndScroll(postNum) {
                    if (this.hasMore) {
                      await this.loadAllPosts();
                    }
                    // Если после догрузки пост так и не появился — показываем алерт
                    const existsInData = Array.isArray(this.allPosts) && this.allPosts.some(p => p.id == postNum);
                    if (!existsInData) {
                      this.showAlert(`Пост #${postNum} не найден`);
                      return;
                    }
                    this.$nextTick(() => { this.scrollToPost(postNum); });
                  },
                 
                 async loadAllPosts() {
                   try {
                     // Загружаем все оставшиеся посты
                     let attempts = 0;
                     const maxAttempts = 50; // Защита от бесконечного цикла
                     
                     while (this.hasMore && attempts < maxAttempts) {
                       await this.loadNextPage();
                       attempts++;
                       
                       // Небольшая задержка между загрузками
                       if (this.hasMore) {
                         await new Promise(resolve => setTimeout(resolve, 100));
                       }
                     }
                     
                     if (attempts >= maxAttempts) {
                       console.warn('Достигнут лимит попыток загрузки постов');
                       this.hasMore = false;
                     }
                   } catch (e) {
                     console.error('Ошибка при загрузке всех постов:', e);
                     this.hasMore = false;
                   }
                 },
                 
                  // Визуальный алерт сверху (красная плашка)
                  showAlert(message) {
                    let banner = document.querySelector('.alert-banner');
                    if (!banner) {
                      banner = document.createElement('div');
                      banner.className = 'alert-banner';
                      document.body.appendChild(banner);
                    }
                    banner.textContent = message;
                    requestAnimationFrame(() => banner.classList.add('show'));
                    clearTimeout(this._alertTimer);
                    this._alertTimer = setTimeout(() => {
                      banner.classList.remove('show');
                    }, 2500);
                  },
                  
                  // Типы файлов
                  isImage(file) {
                    if (!file) return false;
                    if (file.type === 0) return true;
                    const name = (file.name || file.path || '').toLowerCase();
                    return /(\.jpg|\.jpeg|\.png|\.gif|\.webp|\.bmp)$/.test(name);
                  },
                  isVideo(file) {
                    if (!file) return false;
                    if (file.type === 1) return true;
                    const name = (file.name || file.path || '').toLowerCase();
                    return /(\.mp4|\.webm|\.mov|\.m4v|\.avi)$/.test(name);
                  },
                  
                  getPrimaryImage(post) {
                    if (!post || !post.files) return null;
                    const image = post.files.find(f => this.isImage(f));
                    return image || null;
                  },
                  getOtherFiles(post) {
                    if (!post || !post.files) return [];
                    const shown = this.getPrimaryImage(post);
                    return post.files.filter(f => !shown || f !== shown);
                  },
                  getOtherImages(post) {
                    return this.getOtherFiles(post).filter(f => this.isImage(f));
                  },
                  getVideos(post) {
                    if (!post || !post.files) return [];
                    return post.files.filter(f => this.isVideo(f));
                  },
                  
                  // Lightbox
                  openImage(file) {
                    const fullSrc = 'https://2ch.hk' + file.path;
                    const kb = file.size ? Math.round(Number(file.size) / 1024) : null;
                    const info = `${file.name || 'image'}${kb ? ` • ${kb} KB` : ''}`;
                    this.showLightbox(fullSrc, info);
                  },
                  showLightbox(src, infoText) {
                    // Создаем overlay
                    const overlay = document.createElement('div');
                    overlay.className = 'lightbox-overlay';
                    overlay.addEventListener('click', () => document.body.removeChild(overlay));
                    
                    const content = document.createElement('div');
                    content.className = 'lightbox-content';
                    
                    const img = document.createElement('img');
                    img.className = 'lightbox-image';
                    img.src = src;
                    img.alt = infoText || '';
                    
                    const info = document.createElement('div');
                    info.className = 'lightbox-info';
                    info.textContent = infoText || '';
                    
                    const close = document.createElement('button');
                    close.className = 'lightbox-close';
                    close.textContent = 'Закрыть';
                    close.addEventListener('click', (e) => {
                      e.stopPropagation();
                      document.body.removeChild(overlay);
                    });
                    
                    content.appendChild(img);
                    content.appendChild(info);
                    overlay.appendChild(content);
                    overlay.appendChild(close);
                    document.body.appendChild(overlay);
                  },
                 
                 // Обработка свайпа вправо
                 handleTouchStart(e) {
                   this.touchStartX = e.touches[0].clientX;
                   this.touchStartY = e.touches[0].clientY;
                 },
                 
                 handleTouchMove(e) {
                   this.touchEndX = e.touches[0].clientX;
                   this.touchEndY = e.touches[0].clientY;
                   
                   // Показываем индикатор при движении вправо
                   const deltaX = this.touchEndX - this.touchStartX;
                   const deltaY = Math.abs(this.touchEndY - this.touchStartY);
                   
                   if (deltaX > 50 && deltaY < 100) {
                     this.showSwipeIndicator = true;
                   }
                 },
                 
                  handleTouchEnd(e) {
                    // Если был клик/тап внутри интерактивного контента (картинка, ссылка и т.п.) — не триггерим назад
                    const target = e && e.target ? e.target : null;
                    if (target && (target.closest('.post-link') || target.closest('a') || target.closest('img') || target.closest('video') || target.closest('.load-more-btn'))) {
                      this.showSwipeIndicator = false;
                      return;
                    }
                   const deltaX = this.touchEndX - this.touchStartX;
                   const deltaY = Math.abs(this.touchEndY - this.touchStartY);
                   
                   // Если свайп вправо достаточно длинный и горизонтальный
                   if (deltaX > 100 && deltaY < 100) {
                     this.triggerSwipeBack();
                   }
                   
                   // Скрываем индикатор
                   this.showSwipeIndicator = false;
                 },
                 
                 triggerSwipeBack() {
                   // Показываем анимацию свайпа
                   const indicator = document.querySelector('.swipe-indicator');
                   if (indicator) {
                     indicator.classList.add('swiping');
                   }
                   
                   // Задержка перед навигацией для показа анимации
                   setTimeout(() => {
                     this.goBack();
                   }, 300);
                 }
              },
              
                                                            mounted() {
                  this.loadThreadInfo();
                  this.loadPosts();
                  
                  // Добавляем обработчик скролла для ленивой загрузки
                  window.addEventListener('scroll', this.onScroll);
                  
                  // Добавляем обработчики свайпа
                  document.addEventListener('touchstart', this.handleTouchStart, { passive: true });
                  document.addEventListener('touchmove', this.handleTouchMove, { passive: true });
                  document.addEventListener('touchend', this.handleTouchEnd, { passive: true });
                  
                  // Добавляем обработчик кликов по ссылкам на посты
                  this.$nextTick(() => {
                    this.setupPostLinks();
                  });
                  
                  // Сохраняем ссылку на Vue приложение глобально
                  window.vueAppInstance = this;
                },
              
                                             beforeUnmount() {
                  // Убираем обработчик скролла
                  window.removeEventListener('scroll', this.onScroll);
                  
                  // Убираем обработчики свайпа
                  document.removeEventListener('touchstart', this.handleTouchStart);
                  document.removeEventListener('touchmove', this.handleTouchMove);
                  document.removeEventListener('touchend', this.handleTouchEnd);
                  
                  // Убираем обработчик кликов по ссылкам
                  if (this.postLinksHandler) {
                    document.removeEventListener('click', this.postLinksHandler);
                  }
                },
              
                             template: `
                 <div class="thread-container">
                   <!-- Индикатор свайпа вправо -->
                   <div class="swipe-indicator" :class="{ show: showSwipeIndicator }">
                     Свайп вправо для возврата
                   </div>
                   
                    <div class="thread-header">
                      <button class="back-button" @click="goBack">К списку тредов</button>
                      <div class="thread-info">
                        <div class="thread-id">/{{ boardId }}/#{{ threadId }}</div>
                        <div class="thread-title">{{ threadInfo?.title }}</div>
                        <div class="thread-description" v-if="threadInfo?.description">{{ threadInfo.description }}</div>
                      </div>
                    </div>
                  
                  <div v-if="loading" class="error-message">
                    <div class="spinner"></div>
                    <div>Загрузка...</div>
                  </div>
                  
                  <div v-else-if="error" class="error-message">
                    <div>{{ error }}</div>
                    <button class="retry-button" @click="retryLoad">Повторить</button>
                  </div>
                  
                   <div v-else-if="posts.length > 0" class="posts-container">
                                         <div v-for="post in posts" :key="post.id" class="post-card" :data-post-id="post.id">
                      <div class="post-header">
                        <span class="post-number">#{{ post.id }}</span>
                        <span class="post-date">{{ formatTimestamp(post.date) }}</span>
                      </div>
                      
                       <div class="post-content">
                         <div v-if="getPrimaryImage(post)" class="post-thumb">
                           <img
                             :src="'https://2ch.hk' + (getPrimaryImage(post).thumbnail || getPrimaryImage(post).path)"
                             :alt="getPrimaryImage(post).name"
                             loading="lazy"
                             @click="openImage(getPrimaryImage(post))"
                             @error="e => { const img = e.target; const p = getPrimaryImage(post); if (p && p.path) img.src = 'https://2ch.hk' + p.path; }"
                           >
                         </div>
                         <div class="post-info">
                           <div v-if="post.subject" class="post-subject" style="font-weight: bold; margin-bottom: 8px;">
                             {{ post.subject }}
                           </div>
                           <div v-if="post.text" class="post-text" v-html="processPostText(post.text)"></div>

                           <!-- Галерея изображений 2x2 -->
                           <div v-if="getOtherImages(post).length > 0" class="post-gallery">
                             <div v-for="imgFile in getOtherImages(post)" :key="imgFile.path" class="gallery-item">
                               <img
                                 :src="'https://2ch.hk' + (imgFile.thumbnail || imgFile.path)"
                                 :alt="imgFile.name"
                                 loading="lazy"
                                 @click="openImage(imgFile)"
                                 @error="e => { const el = e.target; if (imgFile.path) el.src = 'https://2ch.hk' + imgFile.path; }"
                               >
                             </div>
                           </div>

                           <!-- Видео ниже -->
                           <div v-if="getVideos(post).length > 0" class="post-videos">
                             <video v-for="vid in getVideos(post)" :key="vid.path" :src="'https://2ch.hk' + vid.path" controls preload="metadata"></video>
                           </div>
                         </div>
                       </div>
                    </div>
                    
                    <!-- Индикатор загрузки дополнительных постов -->
                    <div v-if="loadingMore" class="loading-more">
                      <div class="spinner small"></div>
                      <span>Загружаем еще посты...</span>
                    </div>
                    
                    <!-- Кнопка "Загрузить еще" если автоматическая загрузка не сработала -->
                    <div v-if="hasMore && !loadingMore && posts.length > 0" class="load-more-button">
                      <button @click="loadNextPage" class="load-more-btn">
                        Загрузить еще посты
                      </button>
                    </div>
                  </div>
                  
                  <div v-else class="error-message">
                    <div>Посты не найдены</div>
                    <button class="retry-button" @click="retryLoad">Повторить</button>
                  </div>
                </div>
              `
             }).mount('#app');

            // Lightbox корневой контейнер (динамический через Vue template ниже)

            // Показываем приложение
            appLoading.style.display = 'none';
            vueApp.style.display = 'block';
          } catch (e) {
            console.error('Ошибка при инициализации Vue:', e);
          }
        };
        
        // Инициализация Telegram WebApp и автоматическое скрытие экрана загрузки
        setTimeout(function() {
          if (window.Telegram && window.Telegram.WebApp) {
            try {
              // Сообщаем Telegram что приложение готово
              window.Telegram.WebApp.ready();
              window.Telegram.WebApp.expand();
              
              // Принудительно устанавливаем полноэкранный режим
              document.documentElement.style.height = '100%';
              document.body.style.height = '100%';
            } catch (e) {
              console.error('Ошибка при инициализации Telegram WebApp:', e);
            }
          }
          
          // Принудительно скрываем экран загрузки
          setTimeout(function() {
            window.hideLoading();
          }, isIOS ? 1000 : 500);
        }, 100);
        
        // Дополнительная защита: скрываем экран загрузки при загрузке страницы
        window.addEventListener('load', function() {
          setTimeout(function() {
            window.hideLoading();
          }, 500);
        });
      });
    </script>
  </body>
</html>
