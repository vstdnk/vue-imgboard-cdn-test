<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Telegram Mini App Template</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #f0f0f0;
      overflow: hidden; /* Предотвращаем скроллинг тела по умолчанию */
    }
    #app {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    .label {
      font-size: 24px;
      margin-bottom: 20px;
    }
    .button {
      padding: 10px 20px;
      font-size: 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .content {
      overflow-y: auto; /* Разрешаем скроллинг внутри .content, если нужно */
      max-height: 100vh;
    }
    .ios .content {
      /* Дополнительные стили для iOS, если требуется */
    }
    /* Скрываем элементы загрузки и базового приложения, если они не нужны */
    #app-loading, #basic-app {
      display: none;
    }
    .ios-fullscreen {
      /* Дополнительные стили для полноэкранного режима на iOS */
      height: 100vh !important;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="app-loading">Loading...</div>
  <div id="basic-app"></div>
  <div id="app" class="content">
    <!-- Vue будет рендерить здесь -->
  </div>

  <script>
    // Определяем iOS устройства
    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    
    // Базовая проверка наличия Telegram WebApp API
    window.addEventListener('DOMContentLoaded', function() {
      // Элементы страницы
      var appLoading = document.getElementById('app-loading');
      var basicApp = document.getElementById('basic-app');
      var vueApp = document.getElementById('app');
      var isAppHidden = false;
      
      // Настраиваем для iOS
      if (isIOS) {
        document.body.classList.add('ios');
        
        // Специальные настройки для iOS полноэкранного режима
        // Предотвращаем скроллинг страницы целиком на iOS
        document.addEventListener('touchmove', function(event) {
          // Разрешаем скроллинг только внутри элементов с классом content
          if (!event.target.closest('.content')) {
            event.preventDefault();
          }
        }, { passive: false });
      }
      
      // Инициализация Telegram API
      var tg = null;
      if (window.Telegram && window.Telegram.WebApp) {
        tg = window.Telegram.WebApp;
        
        // Отключаем вертикальные свайпы (используем официальный метод с Bot API 7.7+)
        try {
          tg.disableVerticalSwipes();
          console.log('Вертикальные свайпы отключены');
        } catch (e) {
          console.error('Ошибка при отключении вертикальных свайпов:', e);
          // Фallback на low-level postEvent, если метод не поддерживается
          var swipeData = { allow_vertical_swipe: false };
          var swipeEventData = JSON.stringify(swipeData);
          if (window.TelegramWebviewProxy) {
            window.TelegramWebviewProxy.postEvent('web_app_setup_swipe_behavior', swipeEventData);
          } else {
            window.parent.postMessage(JSON.stringify({
              eventType: 'web_app_setup_swipe_behavior',
              eventData: swipeData
            }), '*');
          }
        }
        
        // Скрываем кнопку "Назад"
        try {
          if (tg.BackButton) {
            tg.BackButton.hide();
            console.log('Кнопка "Назад" скрыта');
          }
        } catch (e) {
          console.error('Ошибка при скрытии кнопки "Назад":', e);
        }
        
        // Блокировка ориентации экрана (используем официальный метод с Bot API 8.0+)
        try {
          tg.lockOrientation();
          console.log('Ориентация экрана заблокирована');
        } catch (e) {
          console.error('Ошибка при блокировке ориентации экрана:', e);
          // Fallback на low-level postEvent
          var orientationData = { locked: true };
          var orientationEventData = JSON.stringify(orientationData);
          if (window.TelegramWebviewProxy) {
            window.TelegramWebviewProxy.postEvent('web_app_toggle_orientation_lock', orientationEventData);
          } else {
            window.parent.postMessage(JSON.stringify({
              eventType: 'web_app_toggle_orientation_lock',
              eventData: orientationData
            }), '*');
          }
        }
        
        // Применяем темную тему если нужно
        if (tg.colorScheme === 'dark') {
          document.documentElement.classList.add('dark');
        }
        
        // Настройка переменных CSS на основе Telegram темы
        if (tg.themeParams) {
          document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#f0f0f0');
          document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
          document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#707579');
          document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#2481cc');
          document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#2ea6ff');
          document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
          document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#ffffff');
        }
        
        // Функция активации полноэкранного режима
        var toggleFullScreen = function() {
          try {
            // Скрываем кнопки
            if (tg.BackButton) tg.BackButton.hide();
            if (tg.MainButton) tg.MainButton.hide();
            
            // Добавляем класс для iOS
            if (isIOS) document.body.classList.add('ios-fullscreen');
            
            // Расширяем и запрашиваем полноэкранный режим
            tg.expand();
            tg.requestFullscreen();
            
            // Fallback на low-level expand
            var expandData = { force: true };
            var expandEventData = JSON.stringify(expandData);
            if (window.TelegramWebviewProxy) {
              window.TelegramWebviewProxy.postEvent('web_app_expand', expandEventData);
            } else {
              window.parent.postMessage(JSON.stringify({
                eventType: 'web_app_expand',
                eventData: expandData
              }), '*');
            }
          } catch (e) {
            console.error('Ошибка полноэкранного режима:', e);
          }
        };

        // Функция активации полноэкранного режима с повторами
        var activateFullScreenMode = function(attempts = 0) {
          const maxAttempts = isIOS ? 3 : 2;
          try {
            toggleFullScreen();
            if (isIOS && attempts < maxAttempts) {
              setTimeout(() => activateFullScreenMode(attempts + 1), 300);
            }
          } catch (e) {
            if (attempts < maxAttempts) {
              setTimeout(() => activateFullScreenMode(attempts + 1), 300);
            }
          }
        };
        
        // Запускаем активацию полноэкранного режима
        setTimeout(activateFullScreenMode, isIOS ? 500 : 200);
        
        // Дополнительные события для iOS
        if (isIOS) {
          // При загрузке страницы
          window.addEventListener('load', () => setTimeout(activateFullScreenMode, 500));
          
          // При возвращении на страницу
          document.addEventListener('visibilitychange', () => {
            if (!document.hidden) setTimeout(activateFullScreenMode, 300);
          });
          
          // При получении фокуса
          window.addEventListener('focus', () => setTimeout(activateFullScreenMode, 300));
          
          // При восстановлении из кэша
          window.addEventListener('pageshow', (event) => {
            if (event.persisted) setTimeout(activateFullScreenMode, 300);
          });
        }
      }

      // Инициализация Vue после DOMContentLoaded
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            message: 'Hello, Telegram Mini App!'
          };
        },
        methods: {
          handleClick() {
            alert('Button clicked!');
            // Здесь можно интегрировать Telegram WebApp API, например:
            // if (tg) {
            //   tg.showAlert('Button clicked!');
            // }
          }
        },
        template: `
          <div>
            <div class="label">{{ message }}</div>
            <button class="button" @click="handleClick">Click Me</button>
          </div>
        `
      }).mount('#app');

      // Если нужно показать/скрыть элементы
      appLoading.style.display = 'none';
      vueApp.style.display = 'block';
    });
  </script>
</body>
</html>